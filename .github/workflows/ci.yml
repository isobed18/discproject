name: DISC CI

on:
  push:
    branches: [ main, feature/*, fix/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
      kafka:
        image: bitnami/kafka:3.6.0
        ports:
          - 9092:9092
        env:
          KAFKA_CFG_NODE_ID: 0
          KAFKA_CFG_PROCESS_ROLES: controller,broker
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER

    steps:
    - uses: actions/checkout@v3

    - name: Start OPA
      run: |
        docker run -d -p 8181:8181 --name opa openpolicyagent/opa:latest-static run --server --addr :8181
        sleep 5

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx consistency

    - name: Upload OPA Policy
      run: |
        # Wait for OPA to be ready
        sleep 5
        curl -X PUT --data-binary @backend/policies/main.rego http://localhost:8181/v1/policies/disc/authz

    - name: Run Tests (Integration)
      env:
        PYTHONPATH: backend
        REDIS_URL: redis://localhost:6379/0
        KAFKA_BOOTSTRAP_SERVERS: localhost:9092
        BASE_URL: http://localhost:8005/v1
      run: |
        # Start backend on 8005 to match BASE_URL
        uvicorn backend.main:app --host 0.0.0.0 --port 8005 &
        sleep 10
        python scripts/verify_all.py
