name: DISC CI

on:
  push:
    branches: [ main, feature/*, fix/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3

    - name: Start OPA
      run: |
        docker run -d -p 8181:8181 --name opa openpolicyagent/opa:latest-static run --server --addr :8181
        sleep 5

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx

    - name: Upload OPA Policy
      run: |
        curl -X PUT --data-binary @backend/policies/main.rego http://localhost:8181/v1/policies/disc

    - name: Run Tests (Integration)
      env:
        PYTHONPATH: backend
        REDIS_URL: redis://localhost:6379/0
      run: |
        # In a real pipeline, we would run proper pytest suites.
        # For now, we simulate the verify script or run a basic functional test.
        # Starting backend in background
        uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
        sleep 5
        python scripts/verify_all.py
